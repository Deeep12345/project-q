<!DOCTYPE html>
<!--  Last Published: Fri Apr 03 2020 07:16:42 GMT+0000 (Coordinated Universal Time)  -->
<html data-wf-page="5e841deb90c306d8b47b8d40" data-wf-site="5e7b9ae24c46c726e716ecf3">

<head>
  <meta charset="utf-8">
  <title>Project Q</title>
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link href="../css/normalize.css" rel="stylesheet" type="text/css">
  <link href="../css/webflow.css" rel="stylesheet" type="text/css">
  <link href="../css/project-queue.webflow.css" rel="stylesheet" type="text/css">
  <script src="../js/angular.min.js" type="text/javascript"></script>
  <!-- [if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" type="text/javascript"></script><![endif] -->
  <script type="text/javascript">
    ! function (o, c) {
      var n = c.documentElement,
        t = " w-mod-";
      n.className += t + "js", ("ontouchstart" in o || o.DocumentTouch && c instanceof DocumentTouch) && (n.className += t + "touch")
    }(window, document);
  </script>
  <link href="../images/favicon.ico" rel="shortcut icon" type="image/x-icon">
  <link href="../images/webclip.png" rel="apple-touch-icon">
</head>

<body class="body center" ng-app="updateApp" ng-controller="updateCtrl">
  <div ng-if="isEntering" class="main_div" style="margin: 0;">
    <div class="header_div" style="margin-top: 0;">
      <div class="div-block-22">
        <h1 class="heading-2-copy">Aggiorna le informazioni.</h1>
      </div>
    </div>
    <div class="form-block-2 w-form">
      <form id="email-form" name="email-form" data-name="Email Form" method="get" class="form-2">
        <input type="text" ng-model="people" ng-change="updateNumber(people)" class="text-field-3 w-input"
          autofocus="true" maxlength="256" placeholder="Quante persone hai davanti a te?" id="People" required=""><label
          class="w-checkbox checkbox-field"><input type="checkbox" ng-model="isLastPerson"
            ng-change="changeIsLast(isLastPerson)" class="w-checkbox-input"><span
            class="checkbox-label w-form-label">Sono l&#x27;ultima persona in coda</span></label>
        <button ng-click="submitNumberOfPeople()" class="submit-button w-button">Conferma</button></form>
    </div>
    <div class="div-block-25" style="margin-bottom: 0;">
      <p class="paragraph-13">La community ti ringrazia per il tuo prezioso contributo!</p>
    </div>
  </div>


  <div ng-if="!isEntering" class="main_div" style="margin: 0;">
    <div class="header_div" style="margin-top: 0;">
      <div class="div-block-22">
        <h1 class="heading-2-copy-copy">Un&#x27;ultima cosa</h1>
      </div>
      <div class="div-block-25">
        <p class="paragraph-13">Non appena concludi la coda e stai per entrare nel supermercato clicca il tasto qui in
          basso in modo da rendere i dati da te inseriti ancora pi√π accurati per la community.</p>
      </div>
    </div>
    <div><a ng-click="submitProcessingTime()" class="button-5 w-button">Sto entrando</a></div>
  </div>

  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.4.1.min.220afd743d.js?site=5e7b9ae24c46c726e716ecf3"
    type="text/javascript" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>
  <script src="../js/webflow.js" type="text/javascript"></script>
  <script type="text/javascript">

    var app = angular.module("updateApp", []);
    app.controller("updateCtrl", async ($scope, $http, $window) => {
      $scope.id = $window.location.pathname.replace("/update/", "");


      $scope.people = "";

      $scope.isLastPerson = false;
      $scope.isEntering = true;
      $scope.startTime = "";

      $scope.userEntered = () => {
        $scope.isEntering = false;
      };
      $scope.changeIsLast = (val) => {
        $scope.isLastPerson = val;
      };
      $scope.updateNumber = (val) => {
        $scope.people = val;
      };

      $scope.submitNumberOfPeople = () => {
        if ($scope.isLastPerson) {
          $http.put('/' + $scope.id, { people: $scope.people, lastupdate: new Date() });
        }
        $scope.startTime = Date.now();
        $scope.isEntering = false;
      };

      $scope.submitProcessingTime = () => {
        var endTime = Date.now();
        var diff = endTime - $scope.startTime;
        var pTime =  diff/ (($scope.people +1) * 60000); //divide for 60000 to get minutes from milliseconds
        if (pTime <= 1){
          $window.location.href = '/thanks';
          return;
        } //verify that processing time for each person is greater or equal to 1 minute, to avoid erroneus datas in db
        var points = $scope.userData.processingTime;
        if (points.length < 10) { // if the datas are less than 10, just add the calculated value.No need to validate
          points.push(pTime);// if the existing data is updated as in this case
          $http.put('/' + $scope.id, { processingTime: points });
        } else {
          var sum = 0;
          points.forEach((val) => {
            sum += val;
          });
          var average = sum / (points.length); // get the average of all processing times including the recent one
          diff = Math.abs(pTime - average); 
          if (diff <= average) {
            points.shift();  // discard the first element
            points.push(pTime);
            $http.put('/' + $scope.id, { processingTime: points });
          }
        }
        $window.location.href = '/thanks';
      };
      $http.get("/" + $scope.id)
        .then(function (response) {
          $scope.userData = response.data;
        }).catch((err) => {
        });
    });

  </script>
  <!-- [if lte IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/placeholders/3.0.2/placeholders.min.js"></script><![endif] -->
</body>

</html>